const svgLogo='<svg fill="brown" height=120px viewBox="0 0 24 24"><path d="M5 3C3.9 3 3 3.9 3 5S2.1 7 1 7V9C2.1 9 3 9.9 3 11S3.9 13 5 13H7V11H5V10C5 8.9 4.1 8 3 8C4.1 8 5 7.1 5 6V5H7V3M11 3C12.1 3 13 3.9 13 5S13.9 7 15 7V9C13.9 9 13 9.9 13 11S12.1 13 11 13H9V11H11V10C11 8.9 11.9 8 13 8C11.9 8 11 7.1 11 6V5H9V3H11M22 6V18C22 19.11 21.11 20 20 20H4C2.9 20 2 19.11 2 18V15H4V18H20V6H17.03V4H20C21.11 4 22 4.89 22 6Z" /></svg>',svgLock='<svg height="16pt" viewBox="0 0 24 24"><path d="M12,17A2,2 0 0,0 14,15C14,13.89 13.1,13 12,13A2,2 0 0,0 10,15A2,2 0 0,0 12,17M18,8A2,2 0 0,1 20,10V20A2,2 0 0,1 18,22H6A2,2 0 0,1 4,20V10C4,8.89 4.9,8 6,8H7V6A5,5 0 0,1 12,1A5,5 0 0,1 17,6V8H18M12,3A3,3 0 0,0 9,6V8H15V6A3,3 0 0,0 12,3Z" /></svg>',svgUnlock='<svg height="16pt" viewBox="0 0 24 24"><path d="M18 1C15.24 1 13 3.24 13 6V8H4C2.9 8 2 8.89 2 10V20C2 21.11 2.9 22 4 22H16C17.11 22 18 21.11 18 20V10C18 8.9 17.11 8 16 8H15V6C15 4.34 16.34 3 18 3C19.66 3 21 4.34 21 6V8H23V6C23 3.24 20.76 1 18 1M10 13C11.1 13 12 13.89 12 15C12 16.11 11.11 17 10 17C8.9 17 8 16.11 8 15C8 13.9 8.9 13 10 13Z" /></svg>',svgScan='<path d="M12 20L8.4 15.2C9.4 14.45 10.65 14 12 14S14.6 14.45 15.6 15.2L12 20M4.8 10.4L6.6 12.8C8.1 11.67 9.97 11 12 11S15.9 11.67 17.4 12.8L19.2 10.4C17.19 8.89 14.7 8 12 8S6.81 8.89 4.8 10.4M12 2C7.95 2 4.21 3.34 1.2 5.6L3 8C5.5 6.12 8.62 5 12 5S18.5 6.12 21 8L22.8 5.6C19.79 3.34 16.05 2 12 2M7 24H9V22H7V24M15 24H17V22H15V24M11 24H13V22H11V24Z" />',svgConnect='<path d="M12,21L15.6,16.2C14.6,15.45 13.35,15 12,15C10.65,15 9.4,15.45 8.4,16.2L12,21M12,3C7.95,3 4.21,4.34 1.2,6.6L3,9C5.5,7.12 8.62,6 12,6C15.38,6 18.5,7.12 21,9L22.8,6.6C19.79,4.34 16.05,3 12,3M12,9C9.3,9 6.81,9.89 4.8,11.4L6.6,13.8C8.1,12.67 9.97,12 12,12C14.03,12 15.9,12.67 17.4,13.8L19.2,11.4C17.19,9.89 14.7,9 12,9Z" />',svgSave='<path d="M15,9H5V5H15M12,19A3,3 0 0,1 9,16A3,3 0 0,1 12,13A3,3 0 0,1 15,16A3,3 0 0,1 12,19M17,3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V7L17,3Z" />',svgRestart='<path d="M12,4C14.1,4 16.1,4.8 17.6,6.3C20.7,9.4 20.7,14.5 17.6,17.6C15.8,19.5 13.3,20.2 10.9,19.9L11.4,17.9C13.1,18.1 14.9,17.5 16.2,16.2C18.5,13.9 18.5,10.1 16.2,7.7C15.1,6.6 13.5,6 12,6V10.6L7,5.6L12,0.6V4M6.3,17.6C3.7,15 3.3,11 5.1,7.9L6.6,9.4C5.5,11.6 5.9,14.4 7.8,16.2C8.3,16.7 8.9,17.1 9.6,17.4L9,19.4C8,19 7.1,18.4 6.3,17.6Z" />',svgEye='<path d="M12,9A3,3 0 0,1 15,12A3,3 0 0,1 12,15A3,3 0 0,1 9,12A3,3 0 0,1 12,9M12,4.5C17,4.5 21.27,7.61 23,12C21.27,16.39 17,19.5 12,19.5C7,19.5 2.73,16.39 1,12C2.73,7.61 7,4.5 12,4.5M3.18,12C4.83,15.36 8.24,17.5 12,17.5C15.76,17.5 19.17,15.36 20.82,12C19.17,8.64 15.76,6.5 12,6.5C8.24,6.5 4.83,8.64 3.18,12Z" />',svgNoEye='<path d="M0 0h24v24H0V0z" fill="none"/><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>',svgMenu='<path d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z"/>';var configFile,lastBox,closeCb=function(){},port=location.port||("https:"===window.location.protocol?"443":"80"),esp=`${window.location.protocol}//${window.location.hostname}:${port}/`,options={},$=function(e){return document.getElementById(e)};function hide(e){$(e).classList.add("hide")}function show(e){$(e).classList.remove("hide")}function newEl(e,t){var n=document.createElement(e);if("object"==typeof t)for(var i in t)n.setAttribute(i,t[i]);return n}function getParameters(){var e;show("loader"),fetch(esp+"getStatus").then((e=>e.json())).then((t=>{$("esp-mode").innerHTML=t.mode,$("esp-ip").innerHTML=`<a href="${esp}">${esp}</a>`,$("firmware").innerHTML=t.firmware,$("about").innerHTML="Created with "+t.liburl,$("about").setAttribute("href",t.liburl),configFile=t.path,fetch(esp+configFile).then((e=>e.json())).then((t=>{for(const n in t)if(t.hasOwnProperty(n)){if("name-logo"===n){$("name-logo").innerHTML=t[n].replace(/(<([^>]+)>)/gi,""),document.title=t[n].replace(/(<([^>]+)>)/gi,""),delete t[n];continue}if("img-logo"==n){e=t[n],delete t[n];continue}}e&&fetch(e).then((e=>e.text())).then((t=>setLogoBase64(e,t))),createOptionsBox(options=t),hide("loader")}))}))}function setLogoBase64(e,t){var n=e.replace(/[^\d_]/g,"").split("_"),i=newEl("img",{class:"logo",src:"data:image/png;base64, "+t,style:`width:${n[0]}px;height:${n[1]}px`});$("img-logo").innerHTML="",$("img-logo").append(i),$("img-logo").setAttribute("type","number"),$("img-logo").setAttribute("title","")}function addOptionsElement(e){const t=Object.keys(e).filter((t=>"boolean"==typeof e[t])).reduce(((t,n)=>(t[n]=e[n],t)),{});if(0!==Object.entries(t).length){var n=newEl("div",{class:"row-wrapper"});Object.entries(t).forEach((([e,t])=>{let i=newEl("label",{class:"input-label toggle"}),s=newEl("input",{class:"t-check opt-input",type:"checkbox",id:e});s.checked=t;let a=newEl("div",{class:"toggle-switch"}),o=newEl("span",{class:"toggle-label"});o.textContent=e,i.appendChild(s),i.appendChild(a),i.appendChild(o),addInputListener(s),n.appendChild(i)})),lastBox.appendChild(n)}const i=Object.keys(e).filter((t=>"boolean"!=typeof e[t])).reduce(((t,n)=>(t[n]=e[n],t)),{});Object.entries(i).forEach((([e,t])=>{let n=newEl("label",{class:"input-label","label-for":e});n.textContent=e;let i=newEl("input",{class:"opt-input",type:"text",id:e});if(i.value=t,"number"==typeof t&&i.setAttribute("type","number"),"object"==typeof t)if(t.values)i=newEl("select",{id:e}),t.values.forEach((e=>{var t=newEl("option");t.textContent=e,t.value=e,i.appendChild(t)})),i.value=t.selected,lastBox.appendChild(i);else{var s=Math.round(t.value*(1/t.step))/(1/t.step);i.setAttribute("type","number"),i.setAttribute("step",t.step),i.setAttribute("min",t.min),i.setAttribute("max",t.max),i.value=Number(s).toFixed(3)}addInputListener(i);var a=newEl("div",{class:"tf-wrapper"});a.appendChild(n),a.appendChild(i),lastBox.appendChild(a),e.endsWith("-hidden")&&a.classList.add("hide")}))}function createNewBox(e,t){var n=newEl("div",{class:"ctn opt-box hide",id:"option-box"+e}),i=newEl("h2",{class:"heading-2"});i.innerHTML=t,n.appendChild(i),$("main-box").appendChild(n);var s=newEl("a",{class:"a-link",id:"set-opt"+e,"data-box":"option-box"+e});return s.innerHTML=t,s.addEventListener("click",switchPage),$("nav-link").appendChild(s),n}async function createOptionsBox(e){var t={},n="wifi-box";lastBox=$(n),Object.entries(e).forEach((([i,s],a)=>{if("wifi-box"===n&&($("no-dhcp").checked=e.dhcp,$("ip").value=e.ip_address,$("gateway").value=e.gateway,$("subnet").value=e.subnet,$("no-dhcp").checked&&(show("conf-wifi"),show("save-wifi"))),i.startsWith("param-box"))addOptionsElement(t),lastBox=createNewBox(a,s),t={},n=s;else if("wifi-box"!=n){var o=!1;if(i.startsWith("img-logo")||i.startsWith("name-logo"))o=!0;else if(i.startsWith("raw-css")){var r=newEl("link",{rel:"stylesheet",href:s});document.head.appendChild(r),o=!0}else if(i.startsWith("raw-javascript")){var d=newEl("script",{src:s});document.body.appendChild(d),o=!0}else if(i.startsWith("raw-html")){var l=newEl("div",{class:"tf-wrapper raw-html",id:s,"data-box":lastBox.id});lastBox.appendChild(l),fetch(s).then((e=>e.text())).then((e=>$(s).innerHTML=e)),o=!0}o||(t[i]=s)}})),0!==Object.entries(t).length&&addOptionsElement(t)}function addInputListener(e){"number"!==e.type?"text"!==e.type?"checkbox"!==e.type?"select-one"!==e.type||e.addEventListener("change",(e=>{options[e.target.id].selected=e.target.value})):e.addEventListener("change",(()=>{options[e.id]=e.checked})):e.addEventListener("change",(()=>{options[e.id]=e.value})):e.addEventListener("change",(()=>{if(e.getAttribute("step")){var t={};t.value=Math.round(e.value*(1/e.step))/(1/e.step),t.step=e.getAttribute("step"),t.min=e.getAttribute("min"),t.max=e.getAttribute("max"),options[e.id]=t}else options[e.id]=parseInt(e.value)}))}function insertKey(e,t,n,i){return Object.keys(n).reduce(((s,a,o)=>(o===i&&(s[e]=t),s[a]=n[a],s)),{})}function saveParameters(){Object.keys(options)[0].startsWith("param-box")&&("param-box0"===Object.keys(options)[0]?(options["param-box-0"]=options["wifi-box"],options={dhcp:!1,...options}):options={"wifi-box":"",dhcp:!1,...options}),options.dhcp=$("no-dhcp").checked,$("no-dhcp").checked&&(options=insertKey("ip_address",$("ip").value,options,2),options=insertKey("gateway",$("gateway").value,options,3),(options=insertKey("subnet",$("subnet").value,options,4)).ip_address=$("ip").value,options.gateway=$("gateway").value,options.subnet=$("subnet").value);var e=new Blob([JSON.stringify(options,null,2)],{type:"application/json"}),t=new FormData;t.append("data",e,"/"+configFile),fetch("/edit",{method:"POST",body:t}).then((e=>e.text())).then((e=>{openModal("Save options",'<br><b>"/'+configFile+'"</b> saved successfully on flash memory!<br><br>')}))}function showHidePassword(){var e=$("password");"password"===e.type?(e.type="text",show("show-pass"),hide("hide-pass")):(e.type="password",hide("show-pass"),show("hide-pass"))}function getWiFiList(){show("loader"),fetch(esp+"scan").then((e=>e.json())).then((e=>{listWifi(e),hide("loader")}))}function selectWifi(e){try{$("select-"+e.target.parentNode.id).checked=!0}catch(t){$(e.target.id).checked=!0}$("ssid").value=this.cells[1].innerHTML,$("ssid-name").innerHTML=this.cells[1].innerHTML,$("password").focus()}function listWifi(e){e.hasOwnProperty("reload")&&setTimeout(getWiFiList,2e3),e.sort(((e,t)=>t.strength-e.strength));const t=document.querySelector("#wifi-list");t.innerHTML="",e.forEach(((e,n)=>{var i=newEl("tr"),s="wifi-"+n;i.id=s,i.addEventListener("click",selectWifi),i.innerHTML=`<td><input type="radio" name="select" id="select-${s}"></td>`,i.innerHTML+=`<td id="ssid-${s}">${e.ssid}</td>`,i.innerHTML+='<td class="hide-tiny">'+e.strength+" dBm</td>",i.innerHTML+=e.security?"<td>"+svgLock+"</td>":"<td>"+svgUnlock+"</td>",t.appendChild(i)})),show("wifi-table")}function doConnection(e,t){if(""!==$("ssid").value&&""!==$("password").value){var n=new FormData;n.append("ssid",$("ssid").value),n.append("password",$("password").value),n.append("persistent",$("persistent").checked),void 0!==t&&n.append("newSSID",!0),$("no-dhcp").checked&&(n.append("ip_address",$("ip").value),n.append("gateway",$("gateway").value),n.append("subnet",$("subnet").value));var i,s={method:"POST",body:n,redirect:"follow"};show("loader"),fetch("/connect",s).then((function(e){return i=e.status,e.text()})).then((function(t){200===i?t.includes("already")?openModal("Connect to WiFi",t,(()=>{doConnection(e,!0)})):openModal("Connect to WiFi",t,restartESP):openModal("Error!",t),hide("loader")})).catch((e=>{openModal("Connect to WiFi",e),hide("loader")}))}else openModal("Connect to WiFi","Please insert a SSID and a Password")}function switchPage(e){if($("top-nav").classList.remove("resp"),document.querySelectorAll("a").forEach((e=>{e.classList.remove("active")})),e.target.classList.add("active"),document.querySelectorAll(".opt-box").forEach((e=>{e.classList.add("hide")})),show(e.target.getAttribute("data-box")),"set-wifi"!=e.target.id){var t=document.createDocumentFragment();t.appendChild($("btn-hr")),t.appendChild($("btn-box"));const n=$(e.target.getAttribute("data-box"));n.appendChild(t),document.querySelectorAll(".raw-html").forEach((function(e){e.getAttribute("data-box")===n.id&&n.insertBefore(e,$("btn-hr"))})),show("btn-box"),show("btn-hr")}else hide("btn-box"),hide("btn-hr")}function showMenu(){$("top-nav").classList.add("resp")}function openModal(e,t,n,i){$("message-title").innerHTML=e,$("message-body").innerHTML=t,$("modal-message").open=!0,$("main-box").style.filter="blur(3px)",void 0!==n?(closeCb=n,show("ok-modal")):hide("ok-modal")}function closeModal(e){$("modal-message").open=!1,$("main-box").style.filter="",void 0!==closeCb&&e&&closeCb()}function restartESP(){fetch(esp+"reset").then((e=>e.text())).then((e=>{closeModal(),openModal("Restart!","<br>ESP restarted!")}))}function handleSubmit(){let e=$("file-input");if(0===e.files.length)return void alert("please choose a file");var t=$("update-log");$("loader"),$("progress-wrap");show("loader"),show("progress-wrap"),$("progress-wrap").classList.add("active"),t.innerHTML="Update in progress";let n=new FormData;n.set("update",e.files[0]);var i=new XMLHttpRequest;i.open("POST","/update?size="+e.files[0].size),i.onload=function(e){hide("loader"),$("progress-wrap").classList.remove("active"),t.innerHTML=200!=i.status?`Error ${i.status}: ${i.statusText}`:i.response},i.upload.addEventListener("progress",(e=>{let n=Math.round(e.loaded/e.total*100)+"%";e.lengthComputable&&($("progress-anim").style.width=n,t.innerHTML="Update in progress: "+n)})),i.send(n)}async function uploadFolder(e){let t=$("listing");for(let i of Array.from(e.target.files)){let e=i.webkitRelativePath,s=newEl("li");s.textContent=e,t.appendChild(s);var n=new FileReader;n.onload=function(t){e.startsWith("data/")&&(e=e.replace("data/",""));var n=new FormData;n.set("data",i,"/"+e),fetch("/edit",{method:"POST",body:n}).then((e=>e.text()))},n.readAsText(i)}}$("svg-menu").innerHTML=svgMenu,$("svg-eye").innerHTML=svgEye,$("svg-no-eye").innerHTML=svgNoEye,$("svg-scan").innerHTML=svgScan,$("svg-connect").innerHTML=svgConnect,$("svg-save").innerHTML=svgSave,$("svg-save2").innerHTML=svgSave,$("svg-restart").innerHTML=svgRestart,$("img-logo").innerHTML=svgLogo,$("hum-btn").addEventListener("click",showMenu),$("scan-wifi").addEventListener("click",getWiFiList),$("connect-wifi").addEventListener("click",doConnection),$("save-params").addEventListener("click",saveParameters),$("save-wifi").addEventListener("click",saveParameters),$("show-hide-password").addEventListener("click",showHidePassword),$("set-wifi").addEventListener("click",switchPage),$("set-update").addEventListener("click",switchPage),$("about").addEventListener("click",switchPage),$("restart").addEventListener("click",restartESP),$("picker").addEventListener("change",uploadFolder),$("update-btn").addEventListener("click",handleSubmit),$("file-input").addEventListener("change",(()=>{$("fw-label").innerHTML=$("file-input").files.item(0).name+" ("+$("file-input").files.item(0).size+" bytes)",$("fw-label").style.background="brown"})),$("no-dhcp").addEventListener("change",(function(){this.checked?(show("conf-wifi"),show("save-wifi")):hide("conf-wifi")})),window.addEventListener("load",getParameters);